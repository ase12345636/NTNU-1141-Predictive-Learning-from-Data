# Thresholdï¼ˆé–¾å€¼ï¼‰å®Œæ•´è§£é‡‹

## ğŸ“Š ä»€éº¼æ˜¯Thresholdï¼Ÿ

**Thresholdï¼ˆé–¾å€¼ï¼‰** æ˜¯åœ¨**äºŒå…ƒåˆ†é¡**ä¸­ï¼Œç”¨ä¾†å°‡æ¨¡å‹è¼¸å‡ºçš„**é€£çºŒæ¦‚ç‡å€¼**è½‰æ›ç‚º**é›¢æ•£é æ¸¬çµæœ**ï¼ˆ0æˆ–1ï¼‰çš„**æ±ºç­–é‚Šç•Œ**ã€‚

---

## ğŸ§  æ¨¡å‹æ¶æ§‹ä¸­çš„è³‡æ–™æµ

### 1ï¸âƒ£ **æ¨¡å‹è¼¸å‡º â†’ Logitsï¼ˆåŸå§‹åˆ†æ•¸ï¼‰**

```python
# åœ¨ utils/model.py ä¸­
model = lsnet.lsnet_t(num_classes=14)  # è¼¸å‡ºå±¤æœ‰14å€‹ç¥ç¶“å…ƒ

# å‰å‘å‚³æ’­
logits = model(images)  # shape: [batch_size, 14]
# logitsæ˜¯æœªç¶“ésigmoidçš„åŸå§‹åˆ†æ•¸ï¼Œç¯„åœ: (-âˆ, +âˆ)
# ä¾‹å¦‚: [-2.3, 0.5, 3.1, -0.8, ...]
```

### 2ï¸âƒ£ **Logits â†’ Probabilitiesï¼ˆæ¦‚ç‡ï¼‰**

```python
# ä½¿ç”¨Sigmoidå‡½æ•¸å°‡logitsè½‰æ›ç‚ºæ¦‚ç‡
probabilities = torch.sigmoid(logits)  # shape: [batch_size, 14]
# ç¯„åœ: (0, 1)
# ä¾‹å¦‚: [0.09, 0.62, 0.96, 0.31, ...]
```

**Sigmoidå‡½æ•¸æ•¸å­¸å…¬å¼ï¼š**
```
Ïƒ(x) = 1 / (1 + e^(-x))
```

**è½‰æ›ç¤ºä¾‹ï¼š**
- logit = -2.3 â†’ probability = 0.09 (9%æ©Ÿç‡æœ‰ç—…)
- logit = 0.5  â†’ probability = 0.62 (62%æ©Ÿç‡æœ‰ç—…)
- logit = 3.1  â†’ probability = 0.96 (96%æ©Ÿç‡æœ‰ç—…)

### 3ï¸âƒ£ **Probabilities + Threshold â†’ Predictionsï¼ˆé æ¸¬ï¼‰**

```python
# åœ¨ utils/training_combined.py ç¬¬28è¡Œ
threshold = 0.5  # é€™å°±æ˜¯é–¾å€¼ï¼

# æ‡‰ç”¨é–¾å€¼åšé æ¸¬
predictions = (probabilities > threshold).float()
# è¼¸å‡º: [0, 1, 1, 0, ...]  (0=ç„¡ç—…, 1=æœ‰ç—…)
```

**æ±ºç­–è¦å‰‡ï¼š**
```
å¦‚æœ probability â‰¥ threshold â†’ é æ¸¬ç‚º 1 (æœ‰é€™å€‹ç–¾ç—…)
å¦‚æœ probability < threshold  â†’ é æ¸¬ç‚º 0 (æ²’æœ‰é€™å€‹ç–¾ç—…)
```

---

## ğŸ” ç‚ºä»€éº¼0.5ä¸æ˜¯æœ€ä½³é–¾å€¼ï¼Ÿ

### **å•é¡Œ1: é¡åˆ¥ä¸å¹³è¡¡**

æ‚¨çš„NIH Chest X-rayæ•¸æ“šé›†æœ‰åš´é‡çš„é¡åˆ¥ä¸å¹³è¡¡ï¼š

```python
# ä»¥Infiltrationç‚ºä¾‹
æ­£æ¨£æœ¬ï¼ˆæœ‰ç—…ï¼‰: 6,112 å¼µ
è² æ¨£æœ¬ï¼ˆç„¡ç—…ï¼‰: 19,484 å¼µ
æ¯”ä¾‹: ç´„ 1:3.2

# ä»¥Pneumoniaç‚ºä¾‹
æ­£æ¨£æœ¬: 555 å¼µ
è² æ¨£æœ¬: 25,041 å¼µ
æ¯”ä¾‹: ç´„ 1:45  â† æ¥µåº¦ä¸å¹³è¡¡ï¼
```

### **å•é¡Œ2: æ¨¡å‹åå‘å¤šæ•¸é¡**

ç”±æ–¼è¨“ç·´æ•¸æ“šä¸å¹³è¡¡ï¼Œæ¨¡å‹å‚¾å‘æ–¼ï¼š
- çµ¦å¤šæ•¸é¡ï¼ˆç„¡ç—…ï¼‰è¼ƒé«˜çš„ç½®ä¿¡åº¦
- çµ¦å°‘æ•¸é¡ï¼ˆæœ‰ç—…ï¼‰è¼ƒä½çš„ç½®ä¿¡åº¦

**å¯¦éš›æƒ…æ³ï¼š**
```python
# æŸå¼µçœŸçš„æœ‰Pneumoniaçš„Xå…‰ç‰‡
probability = 0.35  # æ¨¡å‹åªçµ¦35%çš„æ¦‚ç‡

# ä½¿ç”¨threshold=0.5
prediction = (0.35 > 0.5) = False  # é æ¸¬ç‚ºã€Œæ²’æœ‰ã€âŒ éŒ¯èª¤ï¼

# å¦‚æœä½¿ç”¨threshold=0.2
prediction = (0.35 > 0.2) = True   # é æ¸¬ç‚ºã€Œæœ‰ã€âœ“ æ­£ç¢ºï¼
```

---

## ğŸ“ˆ Thresholdå¦‚ä½•å½±éŸ¿æ¨¡å‹è¡¨ç¾

### **è¦–è¦ºåŒ–ç¯„ä¾‹**

å‡è¨­æ¨¡å‹å°100å¼µPneumonia Xå…‰ç‰‡çš„é æ¸¬æ¦‚ç‡åˆ†ä½ˆï¼š

```
çœŸå¯¦æ¨™ç±¤: æœ‰ç—…=40å¼µ, æ²’ç—…=60å¼µ

æ¦‚ç‡åˆ†ä½ˆ:
0.0-0.2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (12å¼µæœ‰ç—…, 30å¼µæ²’ç—…)
0.2-0.4: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     (15å¼µæœ‰ç—…, 20å¼µæ²’ç—…)
0.4-0.6: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ        (8å¼µæœ‰ç—…,  7å¼µæ²’ç—…)
0.6-0.8: â–ˆâ–ˆâ–ˆ          (3å¼µæœ‰ç—…,  2å¼µæ²’ç—…)
0.8-1.0: â–ˆâ–ˆ           (2å¼µæœ‰ç—…,  1å¼µæ²’ç—…)
```

### **ä¸åŒé–¾å€¼çš„å½±éŸ¿ï¼š**

| Threshold | TP | FP | FN | TN | Sensitivity | Precision |
|-----------|----|----|----|----|-------------|-----------|
| **0.2**   | 28 | 30 | 12 | 30 | 70%         | 48%       |
| **0.5** â­| 13 | 10 | 27 | 50 | 33%         | 57%       |
| **0.8**   | 2  | 1  | 38 | 59 | 5%          | 67%       |

**çµè«–ï¼š**
- é–¾å€¼â†“ â†’ Sensitivityâ†‘ï¼ˆæŠ“åˆ°æ›´å¤šç—…äººï¼‰ï¼ŒPrecisionâ†“ï¼ˆä½†èª¤å ±å¢åŠ ï¼‰
- é–¾å€¼â†‘ â†’ Precisionâ†‘ï¼ˆèª¤å ±æ¸›å°‘ï¼‰ï¼ŒSensitivityâ†“ï¼ˆä½†æ¼è¨ºå¢åŠ ï¼‰

---

## ğŸ’» åœ¨æ‚¨çš„ç¨‹å¼ç¢¼ä¸­çš„æ‡‰ç”¨

### **ç›®å‰çš„å•é¡Œï¼ˆresults3/confusion_matrix.jsonï¼‰**

```python
# Infiltrationé¡åˆ¥ - ä½¿ç”¨threshold=0.5
{
  "tp": 0,      # æ­£ç¢ºæª¢æ¸¬åˆ°: 0å¼µ
  "fn": 6112,   # æ¼è¨º: 6112å¼µ  â† 100%æ¼è¨ºç‡ï¼
  "sensitivity": 0.0  # å¬å›ç‡: 0%
}

# Pneumoniaé¡åˆ¥ - ä½¿ç”¨threshold=0.5  
{
  "tp": 0,
  "fn": 555,
  "sensitivity": 0.0  # å¬å›ç‡: 0%
}
```

### **è§£æ±ºæ–¹æ¡ˆ1: å„ªåŒ–é–¾å€¼ï¼ˆoptimize_thresholds.pyï¼‰**

```python
# optimize_thresholds.py çš„æ ¸å¿ƒé‚è¼¯

def find_optimal_threshold_f1(y_true, y_probs):
    """æ‰¾å‡ºä½¿F1åˆ†æ•¸æœ€å¤§çš„é–¾å€¼"""
    best_f1 = 0
    best_threshold = 0.5
    
    # å˜—è©¦ä¸åŒçš„é–¾å€¼
    for threshold in np.linspace(0.1, 0.9, 81):
        predictions = (y_probs >= threshold)
        f1 = f1_score(y_true, predictions)
        
        if f1 > best_f1:
            best_f1 = f1
            best_threshold = threshold
    
    return best_threshold  # ä¾‹å¦‚: 0.23 (è€Œä¸æ˜¯0.5)
```

**é æœŸæ”¹å–„ï¼š**
```python
# Infiltration - ä½¿ç”¨å„ªåŒ–é–¾å€¼=0.23
{
  "tp": 2800,   # â† å¾0å¢åŠ åˆ°2800
  "fn": 3312,   # â† å¾6112æ¸›å°‘åˆ°3312
  "sensitivity": 0.458  # å¬å›ç‡: 46% (å¾0%æå‡)
}
```

### **è§£æ±ºæ–¹æ¡ˆ2: è¨“ç·´æ™‚ä½¿ç”¨æ›´å¹³è¡¡çš„loss**

åœ¨ [main2_balanced.py](main2_balanced.py) ä¸­ï¼š

```python
# èª¿æ•´focal lossåƒæ•¸
gamma = 2.0      # æ›´é—œæ³¨é›£åˆ†é¡æ¨£æœ¬
alpha = 0.5-0.7  # æ›´é—œæ³¨å°‘æ•¸é¡

# é€™æœƒè®“æ¨¡å‹å­¸ç¿’æ™‚æ›´é‡è¦–å°‘æ•¸é¡
# â†’ æ¨¡å‹çµ¦å°‘æ•¸é¡æ›´é«˜çš„æ¦‚ç‡
# â†’ å³ä½¿ç”¨0.5çš„é–¾å€¼ï¼Œä¹Ÿèƒ½æª¢æ¸¬åˆ°æ›´å¤šç—…ä¾‹
```

---

## ğŸ¯ å¯¦å‹™å»ºè­°

### **é†«ç™‚å ´æ™¯ï¼ˆæ‚¨çš„NIH X-rayå°ˆæ¡ˆï¼‰**

**å„ªå…ˆé †åº: Sensitivity > Precision**
- å¯§å¯èª¤å ±ï¼ˆFPï¼‰ï¼Œä¸è¦æ¼è¨ºï¼ˆFNï¼‰
- å› ç‚ºæ¼è¨ºå¯èƒ½å±åŠç”Ÿå‘½

**å»ºè­°ç­–ç•¥ï¼š**
1. âœ… ä½¿ç”¨`optimize_thresholds.py`æ‰¾æœ€ä½³é–¾å€¼
2. âœ… é¸æ“‡**å¬å›ç‡å„ªå…ˆ**çš„é–¾å€¼ï¼ˆ`optimal_thresholds_recall.npy`ï¼‰
3. âœ… è¨­å®šç›®æ¨™: Sensitivity â‰¥ 60-70%

**ç¯„ä¾‹ï¼š**
```python
# ç‚ºæ¯å€‹ç–¾ç—…è¨­å®šä¸åŒé–¾å€¼
optimal_thresholds = {
    'Infiltration': 0.23,   # è¼ƒä½ï¼Œæé«˜å¬å›ç‡
    'Pneumonia': 0.18,      # æ›´ä½ï¼Œé¿å…æ¼è¨º
    'Cardiomegaly': 0.35,   # è¼ƒå®¹æ˜“æª¢æ¸¬ï¼Œå¯ç¨é«˜
    # ...
}

# åœ¨é æ¸¬æ™‚ä½¿ç”¨
for i, disease in enumerate(diseases):
    threshold = optimal_thresholds[disease]
    predictions[:, i] = (probabilities[:, i] > threshold)
```

---

## ğŸ“Š æ•¸å­¸å…¬å¼ç¸½çµ

```
å®Œæ•´æµç¨‹:
Input Image â†’ CNN â†’ Logits â†’ Sigmoid â†’ Probabilities â†’ Threshold â†’ Predictions

æ•¸å­¸è¡¨ç¤º:
x (image) â†’ f(x) (logits) â†’ Ïƒ(f(x)) (probs) â†’ I(Ïƒ(f(x)) > t) â†’ Å· (pred)

å…¶ä¸­:
- Ïƒ(x) = 1/(1+e^(-x))  [Sigmoidå‡½æ•¸]
- I(condition) = 1 if condition else 0  [æŒ‡ç¤ºå‡½æ•¸]
- t = threshold  [é–¾å€¼åƒæ•¸ï¼Œéœ€è¦å„ªåŒ–]
```

---

## ğŸ”§ å¿«é€Ÿæ¸¬è©¦

é‹è¡Œé€™å€‹è…³æœ¬ä¾†ç›´è§€æ„Ÿå—thresholdçš„å½±éŸ¿ï¼š

```python
import torch
import numpy as np

# æ¨¡æ“¬æ¨¡å‹è¼¸å‡º
logits = torch.tensor([-2.0, -0.5, 0.0, 0.5, 2.0])
probabilities = torch.sigmoid(logits)

print("Logits:        ", logits.numpy())
print("Probabilities: ", probabilities.numpy())
print()

for threshold in [0.3, 0.5, 0.7]:
    predictions = (probabilities > threshold).int()
    print(f"Threshold={threshold}: {predictions.numpy()}")

# è¼¸å‡º:
# Logits:         [-2.  -0.5  0.   0.5  2. ]
# Probabilities:  [0.119 0.378 0.5  0.622 0.881]
# 
# Threshold=0.3:  [0 1 1 1 1]  â† æ›´å¤š1ï¼ˆé«˜å¬å›ç‡ï¼‰
# Threshold=0.5:  [0 0 0 1 1]  â† ä¸­ç­‰
# Threshold=0.7:  [0 0 0 0 1]  â† æ›´å°‘1ï¼ˆé«˜ç²¾ç¢ºç‡ï¼‰
```

---

## âœ… ç¸½çµ

**Thresholdçš„æœ¬è³ªï¼š**
- æ˜¯ä¸€å€‹**è¶…åƒæ•¸**ï¼ˆä¸æ˜¯æ¨¡å‹å­¸ç¿’çš„ï¼Œéœ€è¦äººç‚ºè¨­å®šï¼‰
- æ§åˆ¶**precision vs recallçš„æ¬Šè¡¡**
- å°æ–¼ä¸å¹³è¡¡æ•¸æ“šï¼Œ**0.5é€šå¸¸ä¸æ˜¯æœ€ä½³é¸æ“‡**

**æ‚¨çš„å°ˆæ¡ˆä¸­ï¼š**
- âŒ å›ºå®šä½¿ç”¨0.5 â†’ å¬å›ç‡æ¥µä½ï¼ˆ0-5%ï¼‰
- âœ… å„ªåŒ–é–¾å€¼åˆ°0.2-0.3 â†’ å¬å›ç‡æå‡è‡³40-70%

**ä¸‹ä¸€æ­¥ï¼š**
```bash
python optimize_thresholds.py     # æ‰¾æœ€ä½³é–¾å€¼
python evaluate_with_thresholds.py # çœ‹æ”¹å–„æ•ˆæœ
```
